#!/bin/bash

# Script per compilare tutti i file .typ e i file es*_commented.cpp in PDFs
# Crea una struttura pdf/ che replica le cartelle lab*

set -e  # Esce in caso di errore

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PDF_DIR="$SCRIPT_DIR/pdf"

# Crea la cartella pdf se non esiste
mkdir -p "$PDF_DIR"

echo "=== Compilazione PDFs ==="
echo "Directory di lavoro: $SCRIPT_DIR"
echo "Directory output: $PDF_DIR"
echo ""

# Trova tutte le cartelle lab*
for lab_dir in "$SCRIPT_DIR"/lab*/; do
    if [ ! -d "$lab_dir" ]; then
        continue
    fi
    
    lab_name=$(basename "$lab_dir")
    echo "--- Elaborazione $lab_name ---"
    
    # Crea la corrispondente cartella in pdf/
    pdf_lab_dir="$PDF_DIR/$lab_name"
    mkdir -p "$pdf_lab_dir"
    
    cd "$lab_dir"
    
    # Compila tutti i file .typ
    for typ_file in *.typ; do
        if [ -f "$typ_file" ]; then
            echo "  Compilazione $typ_file..."
            typst compile "$typ_file" "$pdf_lab_dir/${typ_file%.typ}.pdf"
        fi
    done
    
    # Compila tutti i file es*_commented.cpp con gen.py
    for cpp_file in es*_commented.cpp; do
        if [ -f "$cpp_file" ]; then
            echo "  Compilazione $cpp_file con gen.py..."
            # gen.py genera il PDF nella directory corrente
            python3 "$SCRIPT_DIR/gen.py" "$cpp_file"
            
            # Il PDF generato ha lo stesso nome del cpp ma con estensione .pdf
            generated_pdf="${cpp_file%.cpp}.pdf"
            
            # Lo rinominiamo rimuovendo "_commented" e lo spostiamo in pdf/
            base_name="${cpp_file%_commented.cpp}"
            final_pdf="$base_name.pdf"
            
            if [ -f "$generated_pdf" ]; then
                mv "$generated_pdf" "$pdf_lab_dir/$final_pdf"
                echo "    â†’ $final_pdf creato"
            else
                echo "    ERRORE: $generated_pdf non trovato"
            fi
        fi
    done
    
    echo ""
done

cd "$SCRIPT_DIR"
echo "=== Compilazione completata ==="
echo "I PDF sono stati salvati in: $PDF_DIR"
